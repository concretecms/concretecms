!function(a,b){"use strict";function c(a,c){var d=this;c=b.extend({setID:"",repetition:"",template:"script[data-template=duration-wrapper]",dateFormat:"",allowRepeat:!0,timeFormat:24},c),d.options=c,d.$element=a,d.setID=c.setID;var e=d.prepareRepetition(d.options.repetition);d.repetition=e;var f=_.template(b(c.template).html(),{repetition:e,options:d.options});d.$element.append(f),d.setup()}function d(a,c){var d=this;c=b.extend({template:"script[data-template=duration-wrapper]",dateFormat:"",baseRepetition:{},repetitions:[],allowRepeat:!0,allowMultiple:!0,namespace:"",timeFormat:24},c),d.options=c,d.$element=a,b.each(d.options.repetitions,function(a,b){d.addRepetition(b)}),d.options.allowMultiple&&a.find("button[data-action=add-duration]").on("click",function(){d.addRepetition(d.options.baseRepetition)})}d.prototype={totalRepetitions:0,addRepetition:function(a){var d=b("<div />"),e=(new Date).getTime(),f=this,g=new c(d,{repetition:a,setID:e,dateFormat:f.options.dateFormat,template:f.options.template,allowRepeat:f.options.allowRepeat,namespace:f.options.namespace,timeFormat:f.options.timeFormat});f.$element.find("div[data-duration-selector]").append(g.getElement()),f.totalRepetitions||g.getElement().find("a[data-delete=duration]").hide(),f.totalRepetitions++,g.getElement().on("click","a[data-delete=duration]",function(a){g.getElement().remove(),f.totalRepetitions--})}},c.prototype={getElement:function(){var a=this;return a.$element},getSetID:function(){var a=this;return a.setID},prepareRepetition:function(a){var b=this,c=moment(1e3*a.pdStartDateTimestamp).tz(a.timezone.timezone),d=!a.repetitionID;if(a.setID=b.setID,a.pdStartDate=c.format("YYYY-MM-DD"),a.pdStartDateSelectTime=b.getTimeFromDate(c,d),a.pdEndDateSelectTime=!1,a.pdEndDateTimestamp){var e=moment(1e3*a.pdEndDateTimestamp).tz(a.timezone.timezone);a.pdEndDate=e.format("YYYY-MM-DD"),a.pdEndDateSelectTime=b.getTimeFromDate(e)}return a},setupTimes:function(){var a=this;a.$element.find("select[data-select=start-time]").selectize({onChange:function(b){a.calculateEndDate()}}),a.$element.find("select[data-select=end-time]").selectize({copyClassesToDropdown:!1})},getSelectedEndDate:function(){var a=this,c=a.$element.find("input[name="+a.options.namespace+"_pdEndDate_pub_"+a.getSetID()+"]").datepicker("option","altFormat"),d=a.$element.find("input[name="+a.options.namespace+"_pdEndDate_"+a.getSetID()+"]").val();if(d){var e=b.datepicker.parseDate(c,d),f=a.$element.find("select[name="+a.options.namespace+"_pdEndDateSelectTime_"+a.getSetID()+"]").val();if(f){var g=f.split(/:/gi)[0],h=f.split(/:/gi)[1].replace(/\D/g,"");return f.match("/pm/i")&&g<12&&(g=parseInt(g)+12),new Date(e.getFullYear(),e.getMonth(),e.getDate(),g,h,0)}}},getSelectedStartDate:function(){var a=this,c=a.$element.find("input[name="+a.options.namespace+"_pdStartDate_pub_"+a.getSetID()+"]").datepicker("option","altFormat"),d=a.$element.find("input[name="+a.options.namespace+"_pdStartDate_"+a.getSetID()+"]").val();if(d){var e=b.datepicker.parseDate(c,d),f=a.$element.find("select[name="+a.options.namespace+"_pdStartDateSelectTime_"+a.getSetID()+"]").val();if(f){var g=f.split(/:/gi)[0],h=f.split(/:/gi)[1].replace(/\D/g,"");return f.match(/pm/i)&&g<12?g=parseInt(g)+12:f.match(/am/i)&&12==g&&(g=0),new Date(e.getFullYear(),e.getMonth(),e.getDate(),g,h,0)}}},getTimeFromDate:function(a,b){var c,d,e,f=a.minutes();switch(this.options.timeFormat){case 12:a.hours()?a.hours()>11?(d="pm",c=a.hours()>12?a.hours()-12:a.hours()):(c=a.hours(),d="am"):(c=12,d="am");break;case 24:c=a.hours(),d=""}return f<10&&(f="0"+f),e=b?f>29?c+":30"+d:c+":00"+d:c+":"+f+d},calculateEndDate:function(){var a=this,c=a.getSelectedStartDate();if(c){var d=c,e=a.$element.find("input[name="+a.options.namespace+"_pdStartDate_pub_"+a.getSetID()+"]").datepicker("option","dateFormat");d.setTime(c.getTime()+36e5);var f=b.datepicker.formatDate(e,d),g=a.getTimeFromDate(moment(d),!1);a.$element.find("input[name="+a.options.namespace+"_pdEndDate_pub_"+a.getSetID()+"]").datepicker("setDate",f);var h=a.$element.find("select[name="+a.options.namespace+"_pdEndDateSelectTime_"+a.getSetID()+"]").selectize();h[0].selectize.setValue(g)}},setupDates:function(){var a=this;a.$element.find("input[name="+a.options.namespace+"_pdStartDate_pub_"+a.getSetID()+"]").datepicker({dateFormat:a.options.dateFormat,altFormat:"yy-mm-dd",altField:a.$element.find("input[name="+a.options.namespace+"_pdStartDate_"+a.getSetID()+"]"),changeYear:!0,showAnim:"fadeIn",yearRange:"c-100:c+10"}),a.$element.find("input[name="+a.options.namespace+"_pdEndDate_pub_"+a.getSetID()+"]").datepicker({dateFormat:a.options.dateFormat,altFormat:"yy-mm-dd",altField:a.$element.find("input[name="+a.options.namespace+"_pdEndDate_"+a.getSetID()+"]"),changeYear:!0,showAnim:"fadeIn",yearRange:"c-100:c+10"}),a.$element.find("input[name="+a.options.namespace+"_pdEndRepeatDateSpecific_pub_"+a.getSetID()+"]").datepicker({dateFormat:a.options.dateFormat,altFormat:"yy-mm-dd",altField:a.$element.find("input[name="+a.options.namespace+"_pdEndRepeatDateSpecific_"+a.getSetID()+"]"),changeYear:!0,showAnim:"fadeIn",yearRange:"c-100:c+10"}),a.$element.find("input[name="+a.options.namespace+"_pdStartDate_pub_"+a.getSetID()+"]").datepicker("setDate",a.getSelectedStartDate()),a.$element.find("input[name="+a.options.namespace+"_pdEndDate_pub_"+a.getSetID()+"]").datepicker("setDate",a.getSelectedEndDate());var c=a.$element.find("input[name="+a.options.namespace+"_pdEndRepeatDateSpecific_pub_"+a.getSetID()+"]").val();if(c){var d=moment(c).tz(a.options.repetition.timezone.timezone);a.$element.find("input[name="+a.options.namespace+"_pdEndRepeatDateSpecific_pub_"+a.getSetID()+"]").datepicker("setDate",d.toDate())}a.$element.find("input[name="+a.options.namespace+"_pdStartDate_pub_"+a.getSetID()+"]").datepicker("option","onSelect",function(){b(this).trigger("change")}),a.$element.find("input[name="+a.options.namespace+"_pdStartDate_pub_"+a.getSetID()+"]").on("change",function(){a.$element.find("input[name="+a.options.namespace+"_pdEndDate_pub_"+a.getSetID()+"]").datepicker("setDate",b(this).val())})},setupRepeatOptions:function(){var a=this;a.$element.find("div[data-wrapper=duration-repeat] input[type=checkbox]").click(function(){a.onActivateDates()}),a.$element.find("select[name="+a.options.namespace+"_pdRepeatPeriod_"+a.getSetID()+"]").change(function(){a.onRepeatPeriodChange()}),a.$element.find("input[name="+a.options.namespace+"_pdRepeat_"+a.getSetID()+"]").click(function(){a.checkRepeat()}),a.$element.find("div[data-wrapper=duration-repeat-dates] input.ccm-input-date").attr("disabled",!0),a.$element.find("input[name="+a.options.namespace+"_pdEndRepeatDate_"+a.getSetID()+"]").change(function(){a.calculateRepeatEnd()})},calculateRepeatOptions:function(){var a=this,c=a.getSelectedStartDate(),d=a.getSelectedEndDate(),e=d.getTime()/1e3-c.getTime()/1e3,f=a.$element.find("div[data-wrapper=duration-repeat-weekly-dow]");switch(e>=86400?(a.$element.find("select[name="+a.options.namespace+"_pdRepeatPeriod_"+a.getSetID()+"] option[value=daily]").prop("disabled",!0),f.hide()):(a.$element.find("select[name="+a.options.namespace+"_pdRepeatPeriod_"+a.getSetID()+"] option[value=daily]").prop("disabled",!1),f.show()),b("input[name="+a.options.namespace+"_pdStartRepeatDate_"+a.getSetID()+"]").val(a.$element.find("input[name="+a.options.namespace+"_pdStartDate_pub_"+a.getSetID()+"]").val()),f.find("input[type=checkbox]").prop("checked",!1),c.getDay()){case 0:f.find("input[value=0]").prop("checked",!0);break;case 1:f.find("input[value=1]").prop("checked",!0);break;case 2:f.find("input[value=2]").prop("checked",!0);break;case 3:f.find("input[value=3]").prop("checked",!0);break;case 4:f.find("input[value=4]").prop("checked",!0);break;case 5:f.find("input[value=5]").prop("checked",!0);break;case 6:f.find("input[value=6]").prop("checked",!0)}},checkRepeat:function(){var a=this;a.$element.find("input[name="+a.options.namespace+"_pdRepeat_"+a.getSetID()+"]").is(":checked")?a.$element.find("div[data-wrapper=duration-repeat-selector]").show():a.$element.find("div[data-wrapper=duration-repeat-selector]").hide()},onActivateDates:function(){var a=this;a.calculateRepeatOptions(),a.$element.find("div[data-wrapper=duration-repeat]").show(),a.$element.find("input[name="+a.options.namespace+"_pdStartDateAllDayActivate_"+a.getSetID()+"]").attr("disabled",!1),a.$element.find("input[name="+a.options.namespace+"_pdStartDateAllDayActivate_"+a.getSetID()+"]").is(":checked")?(a.$element.find("div[data-column=date]").removeClass().addClass("col-sm-12"),a.$element.find("select[data-select=start-time]").parent().hide(),a.$element.find("select[data-select=end-time]").parent().hide()):(a.$element.find("div[data-column=date]").removeClass().addClass("col-sm-6"),a.$element.find("select[data-select=start-time]").parent().show(),a.$element.find("select[data-select=end-time]").parent().show())},onRepeatPeriodChange:function(){var a=this;a.$element.find("div[data-wrapper=duration-dates-repeat-daily]").hide(),a.$element.find("div[data-wrapper=duration-dates-repeat-weekly]").hide(),a.$element.find("div[data-wrapper=duration-dates-repeat-monthly]").hide();var b=a.$element.find("select[name="+a.options.namespace+"_pdRepeatPeriod_"+a.getSetID()+"]").val();b&&(a.$element.find("div[data-wrapper=duration-dates-repeat-"+b+"]").show(),a.$element.find("div[data-wrapper=duration-repeat-dates]").show())},calculateRepeatEnd:function(){var a=this;"date"==a.$element.find("input[name="+a.options.namespace+"_pdEndRepeatDate_"+a.getSetID()+"]:checked").val()?a.$element.find("div[data-wrapper=duration-repeat-dates] input[name="+a.options.namespace+"_pdEndRepeatDateSpecific_pub_"+a.getSetID()+"]").prop("disabled",!1):a.$element.find("div[data-wrapper=duration-repeat-dates] input[name="+a.options.namespace+"_pdEndRepeatDateSpecific_pub_"+a.getSetID()+"]").prop("disabled",!0)},setup:function(){var a=this;a.setupDates(),a.setupTimes(),a.setupRepeatOptions(),a.repetition.pdEndDate||a.calculateEndDate(),a.calculateRepeatOptions(),a.onActivateDates(),a.checkRepeat(),a.onRepeatPeriodChange(),a.calculateRepeatEnd()}},b.fn.concreteDurationSelector=function(a){return b.each(b(this),function(c,e){new d(b(this),a)})},a.ConcreteDurationSelector=d}(this,jQuery);