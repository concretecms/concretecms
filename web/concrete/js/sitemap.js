!function(a,b){"use strict";function c(a,c){var d=this;return c=c||{},c=b.extend({displayNodePagination:!1,cParentID:0,includeSystemPages:!1,displaySingleLevel:!1},c),d.options=c,d.$element=a,d.setupTree(),d.setupTreeEvents(),Concrete.event.publish("ConcreteSitemap",this),d.$element}c.prototype={getTree:function(){var a=this;return a.$element.dynatree("getTree")},setupTree:function(){var a,c=this,d=!0;c.options.displaySingleLevel?(a=1==c.options.cParentID?2:3,d=!1):a=1,b(c.$element).addClass("ccm-tree-sitemap"),b(c.$element).dynatree({autoFocus:!1,cookieId:"ConcreteSitemap",cookie:{path:CCM_REL+"/"},persist:d,initAjax:{url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{displayNodePagination:c.options.displayNodePagination?1:0,cParentID:c.options.cParentID,displaySingleLevel:c.options.displaySingleLevel?1:0,includeSystemPages:c.options.includeSystemPages?1:0}},onPostInit:function(){c.options.displayNodePagination&&c.setupNodePagination(c.$element,c.options.cParentID)},selectMode:1,minExpandLevel:a,clickFolderMode:2,onLazyRead:function(a){c.options.displaySingleLevel?c.displaySingleLevel(a):c.reloadNode(a)},onExpand:function(a,b){a&&c.options.displaySingleLevel&&c.displaySingleLevel(b)},onClick:function(a,d){if("title"==a.getEventTargetType(d)&&a.data.cID)if(c.options.onSelectNode)c.options.onSelectNode.call(c,a);else{var e=new ConcretePageMenu(b(a.span).find(">a"),{menuOptions:c.options,data:a.data,sitemap:c,onHide:function(a){a.$launcher.each(function(){b(this).unbind("mousemove.concreteMenu")})}});e.show(d)}else a.data.href&&(window.location.href=a.data.href)},fx:{height:"toggle",duration:200},dnd:{onDragStart:function(a){return a.data.cID?!0:!1},onDragStop:function(){},autoExpandMS:1e3,preventVoidMoves:!0,onDragEnter:function(){return!0},onDragOver:function(a,b,c){return a.parent.data.cID&&(a.data.cID||"after"!=c)?a.isDescendantOf(b)?!1:!0:!1},onDrop:function(a,b,d){a.parent.data.cID==b.parent.data.cID&&"over"!=d?(b.move(a,d),c.rescanDisplayOrder(b.parent)):c.selectMoveCopyTarget(b,a,d)}}})},setupTreeEvents:function(){var a=this;ConcreteEvent.subscribe("SitemapDeleteRequestComplete",function(){var b=a.$element.dynatree("getActiveNode"),c=b.parent;a.reloadNode(c)})},rescanDisplayOrder:function(a){var c,d=a.getChildren(),e=[];for(a.setLazyNodeStatus(DTNodeStatus_Loading),c=0;c<d.length;c++){var f=d[c];e.push({name:"cID[]",value:f.data.cID})}b.concreteAjax({dataType:"json",type:"POST",data:e,url:CCM_TOOLS_PATH+"/dashboard/sitemap_update",success:function(b){a.setLazyNodeStatus(DTNodeStatus_Ok),ConcreteAlert.notify({message:b.message})}})},selectMoveCopyTarget:function(a,c,d){var e=this,f=ccmi18n_sitemap.moveCopyPage;if(!d)var d="";var g=CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request?origCID="+a.data.cID+"&destCID="+c.data.cID+"&dragMode="+d,h=350,i=350;b.fn.dialog.open({title:f,href:g,width:i,modal:!1,height:h}),ConcreteEvent.subscribe("SitemapDragRequestComplete",function(){var a=c.parent;"over"==d&&(a=c),a.removeChildren(),e.reloadNode(a,function(){c.bExpanded||c.expand(!0)})})},setupNodePagination:function(a){var c=a.find("span.ccm-sitemap-explore-paging");if(a.find("div.ccm-pagination-bound").remove(),c.length){c.find("a").on("click",function(){var c=b(this).attr("href");return a.dynatree("option","initAjax",{url:c}),a.dynatree("getTree").reload(),!1}),c.find("div.ccm-pagination").addClass("ccm-pagination-bound").appendTo(a);var d=b.ui.dynatree.getNode(c);d.remove(),a.dynatree("option","onActivate",function(a){b(a.span).hasClass("ccm-sitemap-explore-paging")&&a.deactivate()})}},displaySingleLevel:function(a){var c=this,d=c.options,e=1==a.data.cID?2:3,f=c.$element.dynatree("getRoot");b(a.li).closest("[data-sitemap=container]").dynatree("option","minExpandLevel",e),f.removeChildren(),f.appendAjax({url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{displayNodePagination:d.displayNodePagination?1:0,cParentID:a.data.cID,displaySingleLevel:!0,includeSystemPages:d.includeSystemPages?1:0},success:function(){c.setupNodePagination(f.tree.$tree,a.data.key)}})},reloadNode:function(a,b){var c=this,d=c.options,e={url:CCM_TOOLS_PATH+"/dashboard/sitemap_data",data:{cParentID:a.data.cID,includeSystemPages:d.includeSystemPages?1:0,displayNodePagination:d.displayNodePagination?1:0},success:function(){b&&b()}};a.appendAjax(e)}},c.exitEditMode=function(a){b.get(CCM_TOOLS_PATH+"/dashboard/sitemap_check_in?cID="+a+"&ccm_token="+CCM_SECURITY_TOKEN)},c.refreshCopyOperations=function(){ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_copy_all",[],ccmi18n_sitemap.copyProgressTitle,function(){b(".ui-dialog-content").dialog("close"),window.location.reload()})},c.submitDragRequest=function(){var a=b("#origCID").val(),c=(b("#destParentID").val(),b("#destCID").val()),d=b("#dragMode").val(),e=b("#destSibling").val(),f=b("input[name=ctask]:checked").val(),g=b("input[name=copyAll]:checked").val(),h=b("input[name=saveOldPagePath]:checked").val(),i={origCID:a,destCID:c,ctask:f,ccm_token:CCM_SECURITY_TOKEN,copyAll:g,destSibling:e,dragMode:d,saveOldPagePath:h};if(1==g){var j=ccmi18n_sitemap.copyProgressTitle;ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_copy_all",[{name:"origCID",value:a},{name:"destCID",value:c}],j,function(){b(".ui-dialog-content").dialog("close"),ConcreteEvent.publish("SitemapDragRequestComplete",{task:f})})}else jQuery.fn.dialog.showLoader(),b.getJSON(CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request",i,function(a){ccm_parseJSON(a,function(){jQuery.fn.dialog.closeAll(),jQuery.fn.dialog.hideLoader(),ConcreteAlert.notify({message:a.message}),ConcreteEvent.publish("SitemapDragRequestComplete",{task:f}),jQuery.fn.dialog.closeTop(),jQuery.fn.dialog.closeTop()})})},b.fn.concreteSitemap=function(a){return b.each(b(this),function(){new c(b(this),a)})},a.ConcreteSitemap=c}(this,$,_),!function(a,b,c){"use strict";function d(a,d){var e=this,d=d||{};d=b.extend({sitemap:!1,data:{},menuOptions:{}},d),ConcreteMenu.call(e,a,d),0!=d.sitemap&&(e.$menu=b(c.template(ConcretePageAjaxSearchMenu.get(),{item:d.data})))}d.prototype=Object.create(ConcreteMenu.prototype),d.prototype.setupMenuOptions=function(a){{var b=this,c=ConcreteMenu.prototype,d=a.attr("data-search-page-menu");b.options.container}c.setupMenuOptions(a),a.find("a[data-action=visit]").on("click",function(){window.location.href=CCM_DISPATCHER_FILENAME+"?cID="+d}),b.options.sitemap&&0!=b.options.sitemap.options.displaySingleLevel||a.find("[data-sitemap-mode=explore]").remove(),a.find("a[data-action=delete-forever]").on("click",function(){return ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_delete_forever",[{name:"cID",value:d}],ccmi18n_sitemap.deletePages,function(){if(b.options.sitemap){var a=b.options.sitemap.getTree(),c=a.getNodeByKey(d);c.remove()}ConcreteAlert.notify({message:ccmi18n_sitemap.deletePageSuccessMsg})}),!1}),a.find("a[data-action=empty-trash]").on("click",function(){return ccm_triggerProgressiveOperation(CCM_TOOLS_PATH+"/dashboard/sitemap_delete_forever",[{name:"cID",value:d}],ccmi18n_sitemap.deletePages,function(){if(b.options.sitemap){var a=b.options.sitemap.getTree(),c=a.getNodeByKey(d);c.removeChildren()}}),!1})},b.fn.concretePageMenu=function(a){return b.each(b(this),function(){new d(b(this),a)})},a.ConcretePageMenu=d}(this,$,_),!function(a,b){"use strict";function c(a,c){var e=this;c=b.extend({mode:"menu"},c),e.options=c,e._templateSearchResultsMenu=_.template(d.get()),ConcreteAjaxSearch.call(e,a,c),e.setupEvents()}c.prototype=Object.create(ConcreteAjaxSearch.prototype),c.prototype.setupEvents=function(){var a=this;ConcreteEvent.subscribe("SitemapDeleteRequestComplete",function(){a.refreshResults()}),ConcreteEvent.fire("ConcreteSitemapPageSearch",a)},c.prototype.updateResults=function(a){var c=this,d=c.$element;ConcreteAjaxSearch.prototype.updateResults.call(c,a),"choose"==c.options.mode&&(d.find(".ccm-search-results-checkbox").parent().remove(),d.find("select[data-bulk-action]").parent().remove(),d.unbind(".concretePageSearchHoverPage"),d.on("mouseover.concretePageSearchHoverPage","tr[data-launch-search-menu]",function(){b(this).addClass("ccm-search-select-hover")}),d.on("mouseout.concretePageSearchHoverPage","tr[data-launch-search-menu]",function(){b(this).removeClass("ccm-search-select-hover")}),d.unbind(".concretePageSearchChoosePage").on("click.concretePageSearchChoosePage","tr[data-launch-search-menu]",function(){return ConcreteEvent.publish("SitemapSelectPage",{instance:c,cID:b(this).attr("data-page-id"),title:b(this).attr("data-page-name")}),!1}))},c.prototype.handleSelectedBulkAction=function(a,c,d,e){if("movecopy"==a){var f,g=[];b.each(e,function(a,c){g.push(b(c).val())}),ConcreteEvent.subscribe("SitemapSelectPage",function(a,c){f=CCM_TOOLS_PATH+"/dashboard/sitemap_drag_request?origCID="+g.join(",")+"&destCID="+c.cID,b.fn.dialog.open({width:350,height:350,href:f,title:ccmi18n_sitemap.moveCopyPage})})}else ConcreteAjaxSearch.prototype.handleSelectedBulkAction.call(this,a,c,d,e)},ConcreteAjaxSearch.prototype.createMenu=function(a){var c=this;a.concretePageMenu({container:c,menu:b("[data-search-menu="+a.attr("data-launch-search-menu")+"]")})};var d={get:function(){return'<div class="ccm-popover-page-menu popover fade" data-search-page-menu="<%=item.cID%>" data-search-menu="<%=item.cID%>"><div class="arrow"></div><div class="popover-inner"><ul class="dropdown-menu"><% if (item.isTrash) { %><li><a data-action="empty-trash" href="javascript:void(0)">'+ccmi18n_sitemap.emptyTrash+'</a></li><% } else if (item.isInTrash) { %><li><a data-action="delete-forever" href="javascript:void(0)">'+ccmi18n_sitemap.deletePageForever+"</a></li><% } else if (item.cAlias == 'LINK' || item.cAlias == 'POINTER') { %><li><a onclick=\"window.location.href='"+CCM_DISPATCHER_FILENAME+'?cID=<%=item.cID%>\'" href="javascript:void(0)">'+ccmi18n_sitemap.visitExternalLink+'</a></li><% if (item.cAlias == \'LINK\' && item.canEditProperties) { %><li><a dialog-width="350" dialog-height="170" dialog-title="'+ccmi18n_sitemap.editExternalLink+'" dialog-modal="false" dialog-append-buttons="true" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=item.cID%>&ctask=edit_external">'+ccmi18n_sitemap.editExternalLink+'</a></li><% } %><% if (item.canDelete) { %><li><a dialog-width="360" dialog-height="150" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.deleteExternalLink+'" href="'+CCM_TOOLS_PATH+'/edit_collection_popup?rel=SITEMAP&cID=<%=item.cID%>&ctask=delete_external">'+ccmi18n_sitemap.deleteExternalLink+'</a></li><% } %><% } else { %><li><a href="#" data-action="visit">'+ccmi18n_sitemap.visitPage+'</a></li><% if (item.canEditPageProperties || item.canEditPageSpeedSettings || item.canEditPagePermissions || item.canEditPageDesign || item.canViewPageVersions || item.canDeletePage) { %><li class="divider"></li><% } %><% if (item.canEditPageProperties) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=item.cID%>)" dialog-width="640" dialog-height="360" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.seo+'" href="'+CCM_DISPATCHER_FILENAME+'/ccm/system/panels/details/page/seo?cID=<%=item.cID%>">'+ccmi18n_sitemap.seo+'</a></li><% if (item.cID > 1) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=item.cID%>)" dialog-width="500" dialog-height="500" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageLocationTitle+'" href="'+CCM_DISPATCHER_FILENAME+'/ccm/system/panels/details/page/location?cID=<%=item.cID%>">'+ccmi18n_sitemap.pageLocation+'</a></li><% } %><li class="divider"></li><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=item.cID%>)" dialog-width="90%" dialog-height="70%" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageAttributesTitle+'" href="'+CCM_DISPATCHER_FILENAME+'/ccm/system/dialogs/page/attributes?cID=<%=item.cID%>">'+ccmi18n_sitemap.pageAttributes+'</a></li><% } %><% if (item.canEditPageSpeedSettings) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=item.cID%>)" dialog-width="550" dialog-height="280" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.speedSettingsTitle+'" href="'+CCM_DISPATCHER_FILENAME+'/ccm/system/panels/details/page/caching?cID=<%=item.cID%>">'+ccmi18n_sitemap.speedSettings+'</a></li><% } %><% if (item.canEditPagePermissions) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=item.cID%>)" dialog-width="500" dialog-height="630" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.setPagePermissions+'" href="'+CCM_DISPATCHER_FILENAME+'/ccm/system/panels/details/page/permissions?cID=<%=item.cID%>">'+ccmi18n_sitemap.setPagePermissions+'</a></li><% } %><% if (item.canEditPageDesign) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=item.cID%>)" dialog-width="350" dialog-height="250" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageDesign+'" href="'+CCM_DISPATCHER_FILENAME+'/ccm/system/dialogs/page/design?cID=<%=item.cID%>">'+ccmi18n_sitemap.pageDesign+'</a></li><% } %><% if (item.canViewPageVersions) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=item.cID%>)" dialog-width="640" dialog-height="340" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.pageVersions+'" href="'+CCM_DISPATCHER_FILENAME+'/ccm/system/panels/page/versions?cID=<%=item.cID%>">'+ccmi18n_sitemap.pageVersions+'</a></li><% } %><% if (item.canDeletePage) { %><li><a class="dialog-launch" dialog-on-close="ConcreteSitemap.exitEditMode(<%=item.cID%>)" dialog-width="360" dialog-height="250" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.deletePage+'" href="'+CCM_DISPATCHER_FILENAME+'/ccm/system/dialogs/page/delete?cID=<%=item.cID%>">'+ccmi18n_sitemap.deletePage+'</a></li><% } %><li class="divider" data-sitemap-mode="explore"></li><li data-sitemap-mode="explore"><a class="dialog-launch" dialog-width="90%" dialog-height="70%" dialog-modal="false" dialog-title="'+ccmi18n_sitemap.moveCopyPage+'" href="'+CCM_TOOLS_PATH+'/sitemap_search_selector?sitemap_select_mode=move_copy_delete&cID=<%=item.cID%>">'+ccmi18n_sitemap.moveCopyPage+'</a></li><li data-sitemap-mode="explore"><a href="'+CCM_DISPATCHER_FILENAME+'/dashboard/sitemap/explore?cNodeID=<%=item.cID%>&task=send_to_top">'+ccmi18n_sitemap.sendToTop+'</a></li><li data-sitemap-mode="explore"><a href="'+CCM_DISPATCHER_FILENAME+'/dashboard/sitemap/explore?cNodeID=<%=item.cID%>&task=send_to_bottom">'+ccmi18n_sitemap.sendToBottom+'</a></li><% if (item.numSubpages > 0) { %><li class="divider"></li><li><a href="'+CCM_DISPATCHER_FILENAME+'/dashboard/sitemap/search/?selectedSearchField[]=parent&cParentAll=1&cParentIDSearchField=<%=item.cID%>">'+ccmi18n_sitemap.searchPages+'</a></li><li><a href="'+CCM_DISPATCHER_FILENAME+'/dashboard/sitemap/explore/-/<%=item.cID%>">'+ccmi18n_sitemap.explorePages+"</a></li><% } %><% } %></ul></div></div>"}};b.fn.concretePageAjaxSearch=function(a){return b.each(b(this),function(){new c(b(this),a)})},a.ConcretePageAjaxSearch=c,a.ConcretePageAjaxSearchMenu=d}(this,$);
//# sourceMappingURL=/concrete/js/sitemap.js.map